# Arduino Integration Steps

## Step 1: Install Required Software

### 1.1 Install Arduino IDE
- Download from: https://www.arduino.cc/en/software
- Install the IDE

### 1.2 Install ESP8266 Board Support
1. Open Arduino IDE
2. Go to **File → Preferences**
3. In "Additional Boards Manager URLs", add:
   ```
   http://arduino.esp8266.com/stable/package_esp8266com_index.json
   ```
4. Go to **Tools → Board → Boards Manager**
5. Search for "ESP8266" and install "esp8266 by ESP8266 Community"
6. Select your board: **Tools → Board → ESP8266 Boards → NodeMCU 1.0 (ESP-12E Module)**

### 1.3 Install Required Libraries
Go to **Sketch → Include Library → Manage Libraries** and install:
- **ArduinoJson** by Benoit Blanchon (version 6.x or 7.x)
- **Servo** (usually pre-installed)

## Step 2: Update Arduino Code

### 2.1 Open the Code
- Open `arduino_box_code.ino` in Arduino IDE

### 2.2 Update WiFi Credentials
Find these lines and update with your WiFi info:
```cpp
const char* ssid = "YOUR_WIFI_SSID";        // Your WiFi network name
const char* password = "YOUR_WIFI_PASSWORD"; // Your WiFi password
```

### 2.3 Update Server IP Address
Find this line and update with your computer's IP:
```cpp
const char* serverUrl = "http://10.130.55.25:4000";  // Your computer's IP
```

**To find your IP:**
- Mac/Linux: Run `ifconfig | grep "inet " | grep -v 127.0.0.1`
- Windows: Run `ipconfig` and look for IPv4 Address
- Or check the terminal output when you start the backend server

### 2.4 Update Box ID (if needed)
```cpp
const String boxId = "BOX_1";  // Change if you have multiple boxes
```

### 2.5 Adjust Servo Settings (if needed)
```cpp
const int OPEN_POS = 90;    // Servo position when open
const int CLOSED_POS = 0;   // Servo position when closed
const int OPEN_TIME = 15000; // How long to keep door open (milliseconds)
```

## Step 3: Hardware Connections

### 3.1 Servo Motor
- **Red wire (VCC)** → 5V or 3.3V (check servo specs)
- **Black/Brown wire (GND)** → GND
- **Orange/Yellow wire (Signal)** → Pin 6 (or change `SERVO_PIN` in code)

### 3.2 Power Supply
- ESP8266 needs good power supply (USB may not be enough for servo)
- Consider using external 5V power supply for servo
- Connect GNDs together

### 3.3 Optional: Button Keypad
If you want physical buttons instead of Serial Monitor:
- Connect 4 buttons to pins D1, D2, D3, D4
- Each button: one side to pin, other side to GND
- Uncomment the button code sections in the Arduino sketch

## Step 4: Upload Code

1. Connect ESP8266 to computer via USB
2. Select correct **Port**: **Tools → Port → (your ESP8266 port)**
3. Click **Upload** button (→) in Arduino IDE
4. Wait for "Done uploading" message
5. Open **Serial Monitor** (Tools → Serial Monitor)
6. Set baud rate to **115200**

## Step 5: Test

### 5.1 Check WiFi Connection
In Serial Monitor, you should see:
```
Connecting to WiFi: YourNetwork
WiFi connected!
IP address: 192.168.x.x
Server URL: http://10.130.55.25:4000
Ready to verify codes!
Enter 4-digit code (digits 1-4 only):
```

### 5.2 Test Code Entry
1. Type a 4-digit code using only digits 1, 2, 3, 4 (e.g., "1234")
2. Press Enter
3. You should see:
   ```
   Verifying code: 1234
   Connecting to server... Sending: {"pickupCode":"1234","boxId":"BOX_1"}
   HTTP Response code: 200
   Response: {"ok":false,"reason":"invalid_code"}
   ❌ Invalid code.
   ```

### 5.3 Test with Valid Code
1. Go to the web app and submit a found card with a box location
2. Note the pickup code (e.g., "3244")
3. Enter that code in Serial Monitor
4. You should see:
   ```
   ✅ Code accepted! Opening door...
   Opening door...
   Door would open for 15 seconds...
   Closing door.
   Door closed.
   ```

## Step 6: Troubleshooting

### Problem: WiFi won't connect
- ✅ Check SSID and password are correct
- ✅ Make sure WiFi is 2.4GHz (ESP8266 doesn't support 5GHz)
- ✅ Check router isn't blocking the device

### Problem: Can't connect to server
- ✅ Make sure backend is running: `cd backend && node src/server.js`
- ✅ Check IP address is correct in Arduino code
- ✅ Make sure computer and Arduino are on same WiFi network
- ✅ Check firewall allows port 4000

### Problem: Servo doesn't move
- ✅ Check wiring (VCC, GND, Signal)
- ✅ Check power supply (servo may need external power)
- ✅ Uncomment `lockServo.attach(SERVO_PIN);` in setup()
- ✅ Adjust OPEN_POS and CLOSED_POS values

### Problem: Code always says "invalid"
- ✅ Make sure you're using a code that was generated by the system
- ✅ Check the code only contains digits 1, 2, 3, 4
- ✅ Verify the code is exactly 4 digits
- ✅ Check boxId matches between Arduino and backend

## Step 7: Production Setup

1. **Remove Serial Monitor dependency** - Use physical buttons or keypad
2. **Add LED indicators** - Green for success, red for failure
3. **Add buzzer** - Audio feedback for code entry
4. **Secure mounting** - Mount ESP8266 and servo in your box
5. **Power management** - Use appropriate power supply for continuous operation

## Quick Reference

**Backend API Endpoint:**
```
POST http://YOUR_IP:4000/api/pickup-request
Body: {"pickupCode": "1234", "boxId": "BOX_1"}
Response: {"ok": true} or {"ok": false, "reason": "..."}
```

**Pickup Code Format:**
- 4 digits
- Only digits: 1, 2, 3, 4
- Examples: "1234", "4321", "2244", "3344"

